<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>í˜¸í¡ê·¼ ê°•í™” ìš´ë™</title>
    <style>
        :root {
            --color-ready: #6c5ce7;
            --color-inhale: #e74c3c; 
            --color-exhale: #3498db; 
            --color-rest: #00b894;   
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        body, html { 
            width: 100%; 
            height: 100vh;
            height: 100dvh;
            overflow: hidden; 
            background: #000;
            -webkit-font-smoothing: antialiased;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        #app-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column;
            transition: background-color 0.5s ease;
            overflow: hidden;
        }

        /* ì´ˆê¸° ì„¤ì • í™”ë©´ */
        #setup-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: max(15px, env(safe-area-inset-top)) 15px max(15px, env(safe-area-inset-bottom)) 15px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-top: max(20px, env(safe-area-inset-top) + 10px);
        }
        
        .setup-header {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            width: 100%;
        }
        
        .setup-header h1 {
            font-size: clamp(1.6rem, 4vw, 2.5rem);
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            line-height: 1.3;
        }
        
        .setup-header p {
            font-size: clamp(0.95rem, 2.5vw, 1.3rem);
            font-weight: 600;
            opacity: 0.95;
        }

        /* ìš´ë™ ì‹¤í–‰ í™”ë©´ */
        #exercise-area { 
            display: none; 
            flex: 1; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-evenly;
            padding: max(15px, env(safe-area-inset-top)) 15px max(15px, env(safe-area-inset-bottom)) 15px;
            color: #fff;
        }

        /* ìƒë‹¨ ì •ë³´ ë°” */
        .top-info-bar { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 0 5px;
        }
        
        #level-indicator { 
            font-size: clamp(1.2rem, 4vw, 1.6rem);
            font-weight: 900; 
            background: rgba(0,0,0,0.25); 
            padding: 8px 20px; 
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #current-round-banner { 
            font-size: clamp(1.4rem, 4.5vw, 2rem);
            font-weight: 900; 
            background: #FFD93D; 
            color: #000; 
            padding: 8px 20px; 
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(255,217,61,0.4);
        }

        /* ì¤‘ì•™ ì§€ì‹œ ì˜ì—­ */
        .instruction-box { 
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        
        #direction-icon { 
            font-size: clamp(80px, 15vh, 200px);
            line-height: 1; 
            display: block;
            margin-bottom: 15px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        #action-text { 
            font-size: clamp(2.8rem, 8vw, 4rem);
            font-weight: 900; 
            text-shadow: 3px 3px 12px rgba(0,0,0,0.4);
            margin-bottom: 10px;
        }

        /* ì›í˜• íƒ€ì´ë¨¸ */
        .circle-wrap { 
            position: relative; 
            width: min(40vw, 35vh, 240px);
            height: min(40vw, 35vh, 240px);
            display: flex; 
            justify-content: center; 
            align-items: center;
            margin: 15px 0;
        }
        
        svg { 
            width: 100%; 
            height: 100%; 
            transform: rotate(-90deg); 
            position: absolute;
        }
        
        #progress-bar { 
            stroke-width: 20; 
            transition: stroke-dashoffset 0.1s linear;
        }
        
        #timer-num { 
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 900; 
            z-index: 5;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .bottom-ui { 
            width: 100%; 
            background: rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            padding: 15px; 
            border-radius: 25px 25px 0 0;
        }
        
        .round-ctrl { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: clamp(20px, 5vw, 35px);
            margin-bottom: 12px;
        }
        
        .ctrl-btn { 
            width: clamp(50px, 12vw, 65px);
            height: clamp(50px, 12vw, 65px);
            border-radius: 15px; 
            border: none; 
            font-size: clamp(1.8rem, 5vw, 2.2rem);
            font-weight: 900; 
            cursor: pointer; 
            background: #fff; 
            color: #000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .ctrl-btn:active {
            transform: scale(0.95);
        }
        
        .round-info {
            text-align: center;
            min-width: 100px;
        }
        
        .round-label {
            color: #eee; 
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        #total-display {
            font-size: clamp(1.6rem, 4.5vw, 2.2rem);
            font-weight: 900;
        }

        .action-btns { 
            display: flex; 
            gap: 12px; 
            width: 100%;
        }
        
        .btn-half { 
            flex: 1; 
            height: clamp(55px, 12vw, 70px);
            border-radius: 18px; 
            border: none; 
            font-size: clamp(1.3rem, 3.5vw, 1.6rem);
            font-weight: 900; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        
        .btn-half:active {
            transform: translateY(2px);
        }

        /* ë‹¨ê³„ ì„ íƒ ê·¸ë¦¬ë“œ */
        .level-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            width: 100%; 
            max-width: 500px;
            margin-bottom: 20px;
        }
        
        .level-btn { 
            height: clamp(65px, 14vw, 90px);
            font-size: clamp(1.1rem, 3.2vw, 1.6rem);
            font-weight: 900; 
            border-radius: 18px; 
            border: none; 
            cursor: pointer; 
            background: rgba(255,255,255,0.95);
            color: #667eea;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .level-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .level-btn:active {
            transform: translateY(0);
        }
        
        /* ì•ˆë‚´ ë°•ìŠ¤ */
        .info-box {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            color: #2c3e50;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }
        
        .info-box h3 {
            font-size: clamp(1.15rem, 3.2vw, 1.5rem);
            margin-bottom: 12px;
            color: #667eea;
        }
        
        .info-box p {
            font-size: clamp(0.95rem, 2.6vw, 1.2rem);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .info-box strong {
            color: #e74c3c;
            font-weight: 800;
        }
        
        /* ì €ì‘ê¶Œ í‘œê¸° */
        .copyright {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: clamp(0.8rem, 2.2vw, 0.95rem);
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px;
            line-height: 1.5;
        }
        
        .copyright a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-weight: 600;
        }
        
        .copyright a:hover {
            text-decoration: underline;
        }

        /* íƒœë¸”ë¦¿ ì´ìƒ */
        @media (min-width: 768px) {
            .level-grid {
                max-width: 600px;
            }
            
            .info-box {
                max-width: 600px;
            }
        }
        
        /* ë°ìŠ¤í¬í†± */
        @media (min-width: 1024px) {
            #exercise-area {
                padding: 30px;
            }
            
            .circle-wrap {
                width: 280px;
                height: 280px;
            }
            
            #direction-icon {
                font-size: 180px;
            }
            
            #action-text {
                font-size: 4.5rem;
            }
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- ì´ˆê¸° ì„¤ì • í™”ë©´ -->
    <main id="setup-area">
        <div class="setup-header">
            <h1>ğŸ’¨ ê±´ê°•í•œ í˜¸í¡ í›ˆë ¨</h1>
            <p>í˜¸í¡ê·¼ ê°•í™” ìš´ë™</p>
        </div>
        
        <div class="level-grid" id="level-btns"></div>
        
        <div class="info-box">
            <h3>ğŸ“‹ ìš´ë™ ë°©ë²•</h3>
            <p><strong>ì¤€ë¹„:</strong> ê¸°êµ¬ë¥¼ ì…ì— ë¬¼ê³  í¸ì•ˆí•˜ê²Œ ì•‰ìœ¼ì„¸ìš”</p>
            <p><strong>1ë‹¨ê³„:</strong> ê¸°êµ¬ë¥¼ í†µí•´ <strong>ê°•í•˜ê²Œ ë“¤ì´ë§ˆì‹œê¸°</strong><br>
               <span style="font-size: 0.95em; color: #666;">â€» ì €í•­ì„ ì´ê¸°ë©° ì½”ì™€ ì…ìœ¼ë¡œ ê¹Šê²Œ í¡ì…</span></p>
            <p><strong>2ë‹¨ê³„:</strong> ê¸°êµ¬ë¥¼ í†µí•´ <strong>ì²œì²œíˆ ëê¹Œì§€ ë‚´ì‰¬ê¸°</strong><br>
               <span style="font-size: 0.95em; color: #666;">â€» ì €í•­ì„ ì´ê¸°ë©° ë°°ì— í˜ì£¼ê³  ì™„ì „íˆ ë°°ì¶œ</span></p>
            <p style="margin-bottom: 0;"><strong>íœ´ì‹:</strong> ìˆ¨ê³ ë¥´ê¸° (ë‹¤ìŒ í˜¸í¡ ì¤€ë¹„)</p>
        </div>
        
        <div class="copyright">
            Â© <a href="https://elantory.com" target="_blank" rel="noopener">elantory.com</a><br>
            All rights reserved.
        </div>
    </main>

    <!-- ìš´ë™ ì‹¤í–‰ í™”ë©´ -->
    <main id="exercise-area">
        <div class="top-info-bar">
            <div id="level-indicator">ì œ 1ë‹¨ê³„</div>
            <div id="current-round-banner">1íšŒì§¸</div>
        </div>

        <div class="instruction-box">
            <span id="direction-icon">âœ‹</span>
            <h2 id="action-text">ì¤€ë¹„í•˜ì„¸ìš”</h2>
        </div>

        <div class="circle-wrap">
            <svg viewBox="0 0 250 250">
                <circle cx="125" cy="125" r="110" stroke="rgba(255,255,255,0.3)" stroke-width="20" fill="none" />
                <circle id="progress-bar" cx="125" cy="125" r="110" stroke="#fff" stroke-width="20" fill="none" stroke-dasharray="691" stroke-dashoffset="691" stroke-linecap="round" />
            </svg>
            <div id="timer-num">!</div>
        </div>

        <div class="bottom-ui">
            <div class="round-ctrl">
                <button class="ctrl-btn" id="round-minus">âˆ’</button>
                <div class="round-info">
                    <p class="round-label">ëª©í‘œ íšŸìˆ˜</p>
                    <p id="total-display">5íšŒ</p>
                </div>
                <button class="ctrl-btn" id="round-plus">+</button>
            </div>
            
            <div class="action-btns">
                <button id="pause-btn" class="btn-half" style="background: #fff; color: #000;">â¸ï¸ ì ì‹œ ë©ˆì¶¤</button>
                <button id="stop-btn" class="btn-half" style="background: rgba(0,0,0,0.8); color: #fff;">â¹ï¸ ì¢…ë£Œ</button>
            </div>
        </div>
    </main>
</div>

<script>
(function() {
    'use strict';
    
    let synth = window.speechSynthesis;
    let audioCtx;
    let isPaused = false;
    let isRunning = false;
    let currentRunId = 0;
    let totalRounds = 5;
    let wakeLock = null;
    let noSleepInterval = null;

    // ë‹¨ê³„ë³„ ì„¤ì •: [ë“¤ìˆ¨ì´ˆ, ë‚ ìˆ¨ì´ˆ, ê¸°ë³¸íšŸìˆ˜]
    const levelSettings = {
        1: [3, 5, 5],
        2: [3, 6, 5],
        3: [4, 6, 6],
        4: [4, 7, 6],
        5: [5, 8, 7],
        6: [5, 9, 8],
        7: [6, 10, 8],
        8: [6, 11, 9],
        9: [7, 12, 10]
    };

    // í™”ë©´ êº¼ì§ ë°©ì§€ - ê°•í™”ëœ ë°©ì‹
    async function requestWakeLock() {
        console.log('í™”ë©´ êº¼ì§ ë°©ì§€ ì‹œì‘');
        
        // ë°©ë²• 1: Wake Lock API ì‹œë„
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock í™œì„±í™” ì„±ê³µ');
                
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock í•´ì œë¨');
                });
                
                // í™”ë©´ ì¬í™œì„±í™” ì‹œ ë‹¤ì‹œ ìš”ì²­
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible' && isRunning) {
                        try {
                            wakeLock = await navigator.wakeLock.request('screen');
                            console.log('Wake Lock ì¬í™œì„±í™”');
                        } catch (err) {
                            console.log('Wake Lock ì¬í™œì„±í™” ì‹¤íŒ¨:', err);
                        }
                    }
                });
            } else {
                console.log('Wake Lock API ë¯¸ì§€ì›');
            }
        } catch (err) {
            console.log('Wake Lock ì‹¤íŒ¨:', err);
        }
        
        // ë°©ë²• 2: ë¹„ë””ì˜¤ ì¬ìƒ (Wake Lock ëŒ€ì²´)
        enableNoSleep();
        
        // ë°©ë²• 3: ì£¼ê¸°ì ì¸ í™”ë©´ í™œì„±í™”
        startKeepAwake();
    }
    
    // í™”ë©´ í™œì„± ìƒíƒœ ìœ ì§€
    function startKeepAwake() {
        if (noSleepInterval) {
            clearInterval(noSleepInterval);
        }
        
        // 30ì´ˆë§ˆë‹¤ ë”ë¯¸ ì´ë²¤íŠ¸ ë°œìƒ
        noSleepInterval = setInterval(() => {
            if (isRunning && !isPaused) {
                window.scrollTo(0, 0);
                document.body.style.transform = 'translateZ(0)';
            }
        }, 30000);
    }
    
    // í™”ë©´ êº¼ì§ ë°©ì§€ - ë¹„ë””ì˜¤ ì¬ìƒ ë°©ì‹
    function enableNoSleep() {
        console.log('NoSleep ë¹„ë””ì˜¤ í™œì„±í™”');
        
        let noSleepVideo = document.getElementById('nosleep-video');
        if (!noSleepVideo) {
            noSleepVideo = document.createElement('video');
            noSleepVideo.id = 'nosleep-video';
            noSleepVideo.setAttribute('playsinline', '');
            noSleepVideo.setAttribute('webkit-playsinline', '');
            noSleepVideo.setAttribute('muted', '');
            noSleepVideo.setAttribute('loop', '');
            noSleepVideo.style.position = 'fixed';
            noSleepVideo.style.opacity = '0';
            noSleepVideo.style.pointerEvents = 'none';
            noSleepVideo.style.width = '1px';
            noSleepVideo.style.height = '1px';
            noSleepVideo.style.zIndex = '-1';
            
            noSleepVideo.innerHTML = `
                <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAr1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTEwIHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAA8GWIhAAV/y7gAAAHAAADAAADAAADABQAAAMAZABzAwAAAzwAACbwFc12Af8CAwAAAQEAAAEAAA==" type="video/mp4">
            `;
            
            document.body.appendChild(noSleepVideo);
        }
        
        const playVideo = () => {
            if (noSleepVideo && isRunning && !isPaused) {
                noSleepVideo.play().then(() => {
                    console.log('NoSleep ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘');
                }).catch((err) => {
                    console.log('NoSleep ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err);
                    setTimeout(playVideo, 1000);
                });
            }
        };
        
        playVideo();
        
        noSleepVideo.addEventListener('ended', playVideo);
        noSleepVideo.addEventListener('pause', playVideo);
    }
    
    // í™”ë©´ êº¼ì§ ë°©ì§€ í•´ì œ
    function disableNoSleep() {
        if (noSleepInterval) {
            clearInterval(noSleepInterval);
            noSleepInterval = null;
        }
        
        const noSleepVideo = document.getElementById('nosleep-video');
        if (noSleepVideo) {
            noSleepVideo.pause();
        }
    }

    // ë¹„í”„ìŒ ìƒì„±
    function playBeep(frequency, duration) {
        if (!audioCtx || isPaused) return Promise.resolve();
        
        return new Promise((resolve) => {
            try {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration / 1000);
                
                setTimeout(resolve, duration);
            } catch (err) {
                resolve();
            }
        });
    }

    // ìŒì„± ì•ˆë‚´
    function speak(text) {
        if (isPaused) return;
        
        try {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 0.8;
            utterance.volume = 0.9;
            synth.speak(utterance);
        } catch (err) {
            // ìŒì„± í•©ì„± ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ
        }
    }

    // í™”ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateVisual(state) {
        const container = document.getElementById('app-container');
        const icon = document.getElementById('direction-icon');
        const action = document.getElementById('action-text');

        switch(state) {
            case 'inhale':
                container.style.backgroundColor = 'var(--color-inhale)';
                icon.innerText = 'â¬†ï¸';
                action.innerText = 'ë“¤ì´ë§ˆì‹œì„¸ìš”';
                speak('ë“¤ì´ë§ˆì‹œì„¸ìš”');
                break;
            case 'exhale':
                container.style.backgroundColor = 'var(--color-exhale)';
                icon.innerText = 'â¬‡ï¸';
                action.innerText = 'ë‚´ì‰¬ì„¸ìš”';
                speak('ë‚´ì‰¬ì„¸ìš”');
                break;
            case 'ready':
                container.style.backgroundColor = 'var(--color-ready)';
                icon.innerText = 'âœ‹';
                action.innerText = 'ì¤€ë¹„í•˜ì„¸ìš”';
                speak('í˜¸í¡ ìš´ë™ì„ ì¤€ë¹„í•˜ì„¸ìš”');
                break;
            case 'rest':
                container.style.backgroundColor = 'var(--color-rest)';
                icon.innerText = 'ğŸ’¨';
                action.innerText = 'íœ´ì‹';
                speak('íœ´ì‹');
                break;
            case 'complete':
                container.style.backgroundColor = '#2ecc71';
                icon.innerText = 'ğŸ‰';
                action.innerText = 'ì™„ë£Œ!';
                speak('ì˜¤ëŠ˜ ìš´ë™ì„ ë¬´ì‚¬íˆ ë§ˆì³¤ìŠµë‹ˆë‹¤');
                break;
        }
    }

    // ëŒ€ê¸° í•¨ìˆ˜
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // íƒ€ì´ë¨¸ ì‹¤í–‰
    async function runTimer(seconds, isInhale, runId) {
        const bar = document.getElementById('progress-bar');
        const display = document.getElementById('timer-num');
        let elapsed = 0;
        const total = seconds * 1000;

        while (elapsed < total) {
            if (runId !== currentRunId || !isRunning) return false;
            
            if (!isPaused) {
                elapsed += 100;
                const progress = elapsed / total;
                bar.style.strokeDashoffset = isInhale ? 691 * (1 - progress) : 691 * progress;
                display.innerText = Math.ceil((total - elapsed) / 1000);
            }
            
            await sleep(100);
        }
        
        return true;
    }

    // ìš´ë™ ì‹œì‘
    async function startExercise(inhaleTime, exhaleTime, rounds, level) {
        // Wake Lock ìš”ì²­
        await requestWakeLock();
        
        // AudioContext ì´ˆê¸°í™”
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (err) {
                // AudioContext ìƒì„± ì‹¤íŒ¨ ì‹œ ê³„ì† ì§„í–‰
            }
        }
        
        if (audioCtx && audioCtx.state === 'suspended') {
            try {
                await audioCtx.resume();
            } catch (err) {
                // Resume ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
            }
        }

        currentRunId++;
        const myRunId = currentRunId;
        
        isRunning = true;
        isPaused = false;
        totalRounds = rounds;
        
        // UI ì „í™˜
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('exercise-area').style.display = 'flex';
        document.getElementById('level-indicator').innerText = `ì œ ${level}ë‹¨ê³„`;
        document.getElementById('total-display').innerText = `${totalRounds}íšŒ`;
        
        // UI ì´ˆê¸°í™”
        document.getElementById('timer-num').innerText = '!';
        document.getElementById('progress-bar').style.strokeDashoffset = '691';
        document.getElementById('current-round-banner').innerText = '1íšŒì§¸';
        document.getElementById('exercise-area').style.opacity = '1';
        
        // ì¤€ë¹„ ë‹¨ê³„
        updateVisual('ready');
        await sleep(3000);
        if (myRunId !== currentRunId) return;

        // ì¹´ìš´íŠ¸ë‹¤ìš´
        for (let i = 3; i > 0; i--) {
            if (myRunId !== currentRunId) return;
            while (isPaused) await sleep(100);
            
            document.getElementById('timer-num').innerText = i;
            await playBeep(700, 200);
            await sleep(1000);
        }

        // ì‹œì‘ ì‹ í˜¸
        await playBeep(1000, 400);
        document.getElementById('timer-num').innerText = '!';
        await sleep(800);
        if (myRunId !== currentRunId) return;

        // ìš´ë™ ë°˜ë³µ
        for (let round = 1; round <= totalRounds; round++) {
            if (myRunId !== currentRunId) return;
            
            document.getElementById('current-round-banner').innerText = `${round}íšŒì§¸`;
            
            // ë“¤ìˆ¨
            updateVisual('inhale');
            const inhaleCompleted = await runTimer(inhaleTime, true, myRunId);
            if (!inhaleCompleted || myRunId !== currentRunId) return;
            
            // ë‚ ìˆ¨
            updateVisual('exhale');
            const exhaleCompleted = await runTimer(exhaleTime, false, myRunId);
            if (!exhaleCompleted || myRunId !== currentRunId) return;
            
            // íœ´ì‹ (ë§ˆì§€ë§‰ íšŒì°¨ ì œì™¸)
            if (round < totalRounds) {
                updateVisual('rest');
                document.getElementById('timer-num').innerText = 'âœ“';
                await sleep(2500);
            }
        }

        // ì™„ë£Œ
        if (myRunId === currentRunId && isRunning) {
            updateVisual('complete');
            document.getElementById('timer-num').innerText = 'ğŸ‰';
            document.getElementById('current-round-banner').innerText = 'ì™„ë£Œ!';
            
            isRunning = false;
            
            // Wake Lock í•´ì œ
            if (wakeLock) {
                try {
                    wakeLock.release();
                } catch (err) {}
                wakeLock = null;
            }
            
            disableNoSleep();
            
            // ì™„ë£Œ í›„ ë²„íŠ¼ ë³€ê²½
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.innerHTML = 'ğŸ”„ ë‹¤ì‹œ ì‹œì‘';
            pauseBtn.style.background = '#2ecc71';
            pauseBtn.style.color = '#fff';
        }
    }

    // ì¢…ë£Œ
    function stopExercise() {
        isRunning = false;
        isPaused = false;
        currentRunId++;
        synth.cancel();
        
        if (wakeLock) {
            try {
                wakeLock.release();
            } catch (err) {}
            wakeLock = null;
        }
        
        disableNoSleep();
        
        document.getElementById('exercise-area').style.display = 'none';
        document.getElementById('setup-area').style.display = 'flex';
        
        document.getElementById('timer-num').innerText = '!';
        document.getElementById('progress-bar').style.strokeDashoffset = '691';
        document.getElementById('direction-icon').innerText = 'âœ‹';
        document.getElementById('action-text').innerText = 'ì¤€ë¹„í•˜ì„¸ìš”';
        document.getElementById('current-round-banner').innerText = '1íšŒì§¸';
        document.getElementById('app-container').style.backgroundColor = 'var(--color-ready)';
        
        const pauseBtn = document.getElementById('pause-btn');
        pauseBtn.innerHTML = 'â¸ï¸ ì ì‹œ ë©ˆì¶¤';
        pauseBtn.style.background = '#fff';
        pauseBtn.style.color = '#000';
        
        document.getElementById('exercise-area').style.opacity = '1';
    }

    // ì¼ì‹œì •ì§€/ì¬ì‹œì‘
    function togglePause() {
        if (!isRunning) {
            const levelIndicator = document.getElementById('level-indicator').innerText;
            const levelMatch = levelIndicator.match(/\d+/);
            if (levelMatch) {
                const level = parseInt(levelMatch[0]);
                const [inhale, exhale] = levelSettings[level];
                
                const pauseBtn = document.getElementById('pause-btn');
                pauseBtn.innerHTML = 'â¸ï¸ ì ì‹œ ë©ˆì¶¤';
                pauseBtn.style.background = '#fff';
                pauseBtn.style.color = '#000';
                
                startExercise(inhale, exhale, totalRounds, level);
            }
            return;
        }
        
        isPaused = !isPaused;
        const btn = document.getElementById('pause-btn');
        const exerciseArea = document.getElementById('exercise-area');
        
        if (isPaused) {
            btn.innerHTML = 'â–¶ï¸ ë‹¤ì‹œ ì‹œì‘';
            btn.style.background = '#2ecc71';
            btn.style.color = '#fff';
            exerciseArea.style.opacity = '0.5';
            synth.cancel();
        } else {
            btn.innerHTML = 'â¸ï¸ ì ì‹œ ë©ˆì¶¤';
            btn.style.background = '#fff';
            btn.style.color = '#000';
            exerciseArea.style.opacity = '1';
        }
    }

    // íšŸìˆ˜ ì¡°ì ˆ
    function adjustRounds(delta) {
        totalRounds = Math.max(1, Math.min(50, totalRounds + delta));
        document.getElementById('total-display').innerText = `${totalRounds}íšŒ`;
    }

    // ì´ˆê¸°í™”
    function init() {
        const grid = document.getElementById('level-btns');
        const levelNames = [
            '1ë‹¨ê³„\n(ê°€ì¥ ì‰¬ì›€)',
            '2ë‹¨ê³„',
            '3ë‹¨ê³„',
            '4ë‹¨ê³„',
            '5ë‹¨ê³„\n(ë³´í†µ)',
            '6ë‹¨ê³„',
            '7ë‹¨ê³„',
            '8ë‹¨ê³„',
            '9ë‹¨ê³„\n(ì–´ë ¤ì›€)'
        ];
        
        for (let i = 1; i <= 9; i++) {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            btn.innerHTML = levelNames[i - 1].replace('\n', '<br>');
            btn.onclick = async () => {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                
                const [inhale, exhale, rounds] = levelSettings[i];
                totalRounds = rounds;
                startExercise(inhale, exhale, rounds, i);
            };
            grid.appendChild(btn);
        }

        document.getElementById('pause-btn').onclick = togglePause;
        document.getElementById('stop-btn').onclick = stopExercise;
        document.getElementById('round-plus').onclick = () => adjustRounds(1);
        document.getElementById('round-minus').onclick = () => adjustRounds(-1);

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && document.getElementById('exercise-area').style.display === 'flex') {
                e.preventDefault();
                togglePause();
            }
        });
    }

    init();
})();
</script>
</body>
</html>
